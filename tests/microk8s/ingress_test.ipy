!rm -f deploy/*/kustomization.yaml deploy/*/__*
!kubectl apply -f deploy/nuvolaris-operator/nuvolaris-common.yaml
!kubectl config set-context --current --namespace nuvolaris
import nuvolaris.kustomize as kus
import nuvolaris.kube as kube
import requests as req, os
import nuvolaris.testutil as tu

tu.read_dotenv()
host = os.environ["MICROK8S_HOST"]

obj = kus.kustom_list("test")
print(kube.apply(obj).strip())
assert( req.get(f"http://{host}").text.find("Thank you for using nginx.") == -1)

data = { "service": "test-svc", "path": "/"}
print(kube.applyTemplate("ingress.yaml", data))
!sleep 3
assert( req.get(f"http://{host}").text.find("Thank you for using nginx.") >= 0)

print(kube.deleteTemplate("ingress.yaml", data))
print(kube.delete(obj))
