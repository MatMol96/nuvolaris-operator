version: '3'
vars:
  IMAGE: nuvolaris/nuvolaris-operator
  REPO: ghcr.io
  TAG:
    sh: git describe --tags --abbrev=0 2>/dev/null || echo latest
  HOSTNAME:
    sh: hostname -f
  APIHOST: http://{{.HOSTNAME}}:8080
  GUEST: "23bc46b1-71f6-4ed5-8c54-816aa4f8c502:123zO3xZCLrMN6v2BKK1dXYFpXlPkccOFqm12CdAsMgRU4VrNZ9lyGVCGuMDGIwP"

tasks:
  kustomization:
    cmds:
    - |
      cat <<__EOF__ >deploy/kustomization.yaml
      apiVersion: kustomize.config.k8s.io/v1beta1
      kind: Kustomization
      images:
      - name: {{.REPO}}/{{.IMAGE}}
        newTag: {{.TAG}}
      resources:
      - operator-crd.yaml
      - operator-roles.yaml
      - operator-pod.yaml
      __EOF__

  config: wsk property set --apihost http://localhost:3233 --auth '{{.GUEST}}'

  deploy:
  - task: kustomization
  - kubectl apply -k deploy
  - kubectl -n nuvolaris wait --for=condition=ready pod/nuvolaris-operator
  - kubectl apply -f operator-obj.yaml

  enter: kubectl exec -ti nuvolaris-operator -- bash

  destroy:
  - task: kustomization
  - kubectl delete -k deploy

  test:
  - jest 
